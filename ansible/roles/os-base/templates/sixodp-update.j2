#!/bin/sh

set -o errexit
set -o nounset

cd /root/sixodp
GIT_COMMIT_OLD="$(git rev-parse HEAD)"
git pull
GIT_COMMIT_NEW="$(git rev-parse HEAD)"

if [ "$GIT_COMMIT_NEW" != "$GIT_COMMIT_OLD" ] ; then
	git submodule sync
	git submodule update --init --recursive

	aws s3 cp s3://sixodp-secrets/{{ deployment_environment_id }}/secrets.yml /root/sixodp-secrets/{{ deployment_environment_id }}/secrets.yml
	aws s3 cp s3://sixodp-secrets/{{ deployment_environment_id }}/google_analytics_credentials.json /root/sixodp-secrets/{{ deployment_environment_id }}/google_analytics_credentials.json
	chmod -R go-rwx /root/sixodp-secrets/*

	cd /root/sixodp/ansible
	ansible-playbook -i inventories/{{ deployment_environment_id }} deploy-transitional.yml
fi
