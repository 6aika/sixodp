From 1814a0651715f33957cc1a83c86a869a0e8a73d4 Mon Sep 17 00:00:00 2001
From: Ian Ward <ian@excess.org>
Date: Sun, 16 Nov 2025 08:45:56 -0500
Subject: [PATCH 1/3] [#9162] test markdown_extract html removal

(cherry picked from commit 9f63665f04463f4b760b72d9aabb172b1de24151)
---
 ckan/tests/lib/test_helpers.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/ckan/tests/lib/test_helpers.py b/ckan/tests/lib/test_helpers.py
index 31507f62ba1..91596a1b40f 100644
--- a/ckan/tests/lib/test_helpers.py
+++ b/ckan/tests/lib/test_helpers.py
@@ -726,7 +726,7 @@ def test_sanitize_url():


 def test_extract_markdown():
-    with_html = u"""Data exposed: &mdash;
+    with_html = u"""<i>Data</i> *exposed*: &mdash;
 Size of dump and data set: size?
 Notes: this is the classic RDF source but historically has had some problems with RDF correctness.
 """

From f2a89aa6792981ca475459975033d013b5f3de96 Mon Sep 17 00:00:00 2001
From: Ian Ward <ian@excess.org>
Date: Sun, 16 Nov 2025 08:47:59 -0500
Subject: [PATCH 2/3] [#9162] fix for markdown_extract tag removal

(cherry picked from commit 0d8c819ab487cf6d4f6ae9417f47e3dfb46308c1)
---
 ckan/lib/helpers.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/ckan/lib/helpers.py b/ckan/lib/helpers.py
index 39ac638d52d..cf2076af80a 100644
--- a/ckan/lib/helpers.py
+++ b/ckan/lib/helpers.py
@@ -1325,7 +1325,7 @@ def markdown_extract(text: str,
     will not be truncated.'''
     if not text:
         return ''
-    plain = bleach_clean(markdown(text), strip=True)
+    plain = bleach_clean(markdown(text), tags=(), strip=True)
     if not extract_length or len(plain) < extract_length:
         return literal(plain)
     return literal(

From bb180035249f46b673b004d853af07a2811dc14f Mon Sep 17 00:00:00 2001
From: Ian Ward <ian@excess.org>
Date: Sun, 16 Nov 2025 08:53:52 -0500
Subject: [PATCH 3/3] [#9162] changelog

(cherry picked from commit c759f8811f9f4d67f1cce57949927f9d0d9f9d56)
---
 changes/9162.bugfix | 1 +
 1 file changed, 1 insertion(+)
 create mode 100644 changes/9162.bugfix

diff --git a/changes/9162.bugfix b/changes/9162.bugfix
new file mode 100644
index 00000000000..5c26f846e01
--- /dev/null
+++ b/changes/9162.bugfix
@@ -0,0 +1 @@
+fix for markdown_extract tag removal bug introduced in 112afff
