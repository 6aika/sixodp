---

- name: Ensure nginx is installed
  action: apt pkg="nginx" state=latest
  tags:
    - nginx
    - packages

- name: Copy base Nginx configuration
  template: src="nginx.conf.j2" dest=/etc/nginx/nginx.conf mode=0644 owner=root group=root
  tags:
    - nginx

- name: Copy Nginx sites
  template: src={{ item.template }} dest=/etc/nginx/{{ item.destination }} mode=0644 owner=root group=root
  with_items:
    - { 'template':'nginx_site_config.j2','destination':'sites-available/ytp', 'ssl_crt': "{{ ssl_crt_primary }}", 'ssl_key': "{{ ssl_key_primary }}", 'server_name': "{{ hostname }}", 'root_redirect': false, 'base_hostname': "{{ base_hostname }}" }
  tags:
    - nginx

- name: Disable default site
  file: path="/etc/nginx/sites-enabled/default" state=absent

- name: Enable Nginx site
  file: src="/etc/nginx/sites-available/{{ item }}" dest="/etc/nginx/sites-enabled/{{ item }}" state=link
  with_items:
    - "ytp"
  tags:
    - nginx
  notify: Restart Nginx

- name: Ensure Nginx is restarted
  service: name=nginx state=restarted
  tags:
    - nginx

#- include: maintenance-start.yml
