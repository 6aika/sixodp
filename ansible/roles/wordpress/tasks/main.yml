---
- name: Install python-mysqldb
  apt:
    name: python-mysqldb

- name: Download WP-CLI
  get_url:
    url: https://github.com/wp-cli/wp-cli/releases/download/v{{ wp_cli_version }}/wp-cli-{{ wp_cli_version }}.phar
    dest: /usr/local/bin/wp
    mode: 0755
    checksum: "{{ wp_cli_checksum }}"

- name: Create database
  mysql_db:
    name: wordpress
    encoding: utf8
    login_host: "{{ wordpress_database_host }}"
    login_user: "{{ wordpress_database_admin_user }}"
    login_password: "{{ wordpress_database_admin_password }}"

- name: Create database user
  mysql_user:
    name: wordpress
    host: "%"
    password: "{{ secret.wordpress_database_password }}"
    priv: "wordpress.*:ALL"
    login_host: "{{ wordpress_database_host }}"
    login_user: "{{ wordpress_database_admin_user }}"
    login_password: "{{ wordpress_database_admin_password }}"

- name: Create WordPress directory
  file:
    state: directory
    path: /opt/wordpress
    owner: www-data
    group: www-data

- block:

  - name: Download WordPress
    command:
      wp core download --path=/opt/wordpress
    args:
      creates: /opt/wordpress/index.php

  - name: Check if EFS is available
    stat:
      path: /mnt/wp-uploads
    register: stat_result

  - name: Create symbolic link to EFS for uploads
    file:
      src: /mnt/wp-uploads
      path: /opt/wordpress/wp-content/uploads
      state: link
    when: stat_result.stat.exists

  - name: Configure WordPress
    command: >
      wp core config
        --path=/opt/wordpress
        --dbhost={{ wordpress_database_host }}
        --dbname={{ wordpress_database_name }}
        --dbuser={{ wordpress_database_user }}
        --dbpass={{ secret.wordpress_database_password }}
    args:
      creates: /opt/wordpress/wp-config.php

  - name: Install WordPress
    command: >
      wp core install
        --path=/opt/wordpress
        --url=https://{{ public_facing_hostname }}/
        --title=6aika
        --admin_user={{ wordpress_admin_user }}
        --admin_password={{ secret.wordpress_admin_password }}
        --admin_email={{ wordpress_admin_email }}

  - name: Install and activate plugins
    command: >
      wp plugin install
        --path=/opt/wordpress
        --activate
        {{ wordpress_plugins|join(' ') }}
    when: wordpress_plugins

  - name: Change permalink structure
    command: >
      wp option set
        --path=/opt/wordpress
        permalink_structure /%postname%/

  become: yes
  become_user: www-data

- name: Create symbolic link to sixodp theme
  file:
    src: /vagrant/sixodp
    dest: /opt/wordpress/wp-content/themes/sixodp
    state: link
  when: deployment_environment_id == "vagrant"

- name: Synchronize sixodp theme
  synchronize:
    src: ../sixodp/
    dest: /opt/wordpress/wp-content/themes/sixodp/
    delete: true
  when: deployment_environment_id != "vagrant"

- name: Activate sixodp theme
  command: wp theme activate sixodp --path=/opt/wordpress
  become: yes
  become_user: www-data

- include: local_plugin.yml
  with_items: "{{ wordpress_local_plugins }}"
